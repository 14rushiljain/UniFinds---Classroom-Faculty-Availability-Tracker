<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>University Timetable Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .navbar { background-color: #ffffff; border-bottom: 1px solid #dee2e6; }
        .filter-bar { background-color: #ffffff; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-top: 2rem; }
        .day-header { color: #0d6efd; font-weight: 500; margin-top: 2.5rem; margin-bottom: 1rem; }
        .schedule-card, .search-result-card { background-color: #ffffff; border: 1px solid #e9ecef; border-radius: 0.5rem; padding: 1.25rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
        .card-item { font-size: 0.9rem; color: #6c757d; }
        .card-item strong { color: #212529; }
        .free-room-badge { font-size: 0.95rem; font-weight: 500; padding: 0.5em 0.75em; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">University Timetable Dashboard</span>
            <a href="/admin" class="btn btn-outline-secondary btn-sm" target="_blank">Admin Panel</a>
        </div>
    </nav>

    <div class="container">
        <div class="filter-bar">
            <div class="row g-2 align-items-center">
                <div class="col-md-3">
                    <select id="program-select" class="form-select" disabled><option>Loading Programs...</option></select>
                </div>
                <div class="col-md-3">
                    <select id="section-select" class="form-select" disabled><option>Select Program First</option></select>
                </div>
                <div class="col-md-3">
                    <select id="day-select" class="form-select" disabled><option>Select Day</option></select>
                </div>
                <div class="col-md-3">
                    <select id="time-select" class="form-select" disabled><option>Select Time</option></select>
                </div>
            </div>
            <div class="row g-2 mt-2">
                <div class="col-md-12">
                     <form id="search-form" class="input-group">
                        <input type="search" id="search-input" class="form-control" placeholder="Search for any subject..." disabled>
                        <button class="btn btn-outline-secondary" type="submit" id="search-button" disabled>Search</button>
                    </form>
                </div>
            </div>
        </div>

        <div id="schedule-display">
            <p id="info-text" class="text-center text-muted mt-5">Please select a program to begin.</p>
        </div>
    </div>

<script>
    // --- DOM Elements ---
    const programSelect = document.getElementById('program-select');
    const sectionSelect = document.getElementById('section-select');
    const daySelect = document.getElementById('day-select');
    const timeSelect = document.getElementById('time-select');
    const searchForm = document.getElementById('search-form');
    const searchInput = document.getElementById('search-input');
    const searchButton = document.getElementById('search-button');
    const displayDiv = document.getElementById('schedule-display');
    const infoText = document.getElementById('info-text');

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', loadInitialData);
    programSelect.addEventListener('change', loadSections);
    sectionSelect.addEventListener('change', fetchAndDisplaySchedule);
    daySelect.addEventListener('change', fetchAndDisplaySchedule);
    timeSelect.addEventListener('change', fetchClassAndFreeRooms);
    searchForm.addEventListener('submit', handleSearch);

    // --- Functions ---

    /**
     * Called on page load. Fetches all programs, days, and time slots
     * from the database to populate the main filters.
     */
    async function loadInitialData() {
        try {
            const response = await fetch('/get_initial_data');
            const data = await response.json();

            populateDropdown(programSelect, data.programs, 'Select Program');
            populateDropdown(daySelect, data.days, 'Select Day');
            populateDropdown(timeSelect, data.time_slots, 'Select Time');

            // Enable search
            searchInput.disabled = false;
            searchButton.disabled = false;
            infoText.textContent = 'Please select a program and section to view schedules.';

        } catch (error) {
            infoText.textContent = 'Failed to load initial data. Please reload the page.';
        }
    }

    /**
     * Called when a Program is selected. Fetches all sections
     * for that specific program.
     */
    async function loadSections() {
        const selectedProgram = programSelect.value;
        if (!selectedProgram) {
            populateDropdown(sectionSelect, [], 'Select Program First');
            sectionSelect.disabled = true;
            return;
        }

        try {
            const response = await fetch(`/get_sections_for_program?program=${selectedProgram}`);
            const sections = await response.json();
            populateDropdown(sectionSelect, sections, 'Select Section');
            sectionSelect.disabled = false;
        } catch (error) {
            infoText.textContent = 'Failed to load sections for this program.';
        }
    }

    function populateDropdown(selectElement, options, defaultText) {
        selectElement.innerHTML = `<option value="">${defaultText}</option>`;
        options.forEach(option => {
            const opt = document.createElement('option');
            opt.value = option;
            opt.textContent = option;
            selectElement.appendChild(opt);
        });
        selectElement.disabled = false;
    }

    /**
     * Fetches and displays the full schedule for the selected
     * Program, Section, and Day.
     */
    async function fetchAndDisplaySchedule() {
        timeSelect.value = ""; // Reset time selector
        const selectedProgram = programSelect.value;
        const selectedSection = sectionSelect.value;
        const selectedDay = daySelect.value;

        if (!selectedProgram || !selectedSection || !selectedDay) return;

        try {

            const response = await fetch(`/get_day_schedule?program=${selectedProgram}&section=${selectedSection}&day=${selectedDay}`);
            const schedule = await response.json();
            if (schedule.error) throw new Error(schedule.error);

            let html = `<h3 class="day-header">${selectedDay} Schedule</h3>`;
            if (schedule.length === 0) {
                html += '<p class="text-muted">No classes scheduled for this day.</p>';
            } else {
                schedule.forEach(cls => { html += createCardHtml(cls); });
            }
            displayDiv.innerHTML = html;
        } catch (error) {
            displayDiv.innerHTML = `<p class="text-center text-danger mt-5">Failed to fetch schedule: ${error.message}</p>`;
        }
    }

    /**
     * Fetches the specific class and all free rooms
     * for the selected Program and Time.
     */
    async function fetchClassAndFreeRooms() {
        const selectedProgram = programSelect.value;
        const selectedSection = sectionSelect.value;
        const selectedTime = timeSelect.value;

        // Don't run if time is un-selected
        if (!selectedTime) {
            fetchAndDisplaySchedule(); // Revert to day view
            return;
        }

        if (!selectedProgram || !selectedSection) {
            infoText.textContent = "Please select a Program and Section first.";
            return;
        }

        // Create promises for both API calls
        const classPromise = fetch(`/get_class_by_time?program=${selectedProgram}&section=${selectedSection}&time=${selectedTime}`);
        const freeRoomsPromise = fetch(`/get_free_rooms?time=${selectedTime}`);

        try {
            const [classResponse, freeRoomsResponse] = await Promise.all([classPromise, freeRoomsPromise]);
            const classResult = await classResponse.json();
            const freeRoomsResult = await freeRoomsResponse.json();

            if (classResult.error) throw new Error(classResult.error);
            if (freeRoomsResult.error) throw new Error(freeRoomsResult.error);

            let html = '';
            html += `<h3 class="day-header">${selectedProgram} / ${selectedSection} at ${selectedTime}</h3>`;
            if (classResult.status === "Free Period") {
                html += '<p class="text-muted">Your section has a free period.</p>';
            } else {
                html += createCardHtml(classResult);
            }

            html += `<h3 class="day-header mt-4">Available Rooms at ${selectedTime}</h3>`;
            if (freeRoomsResult.length === 0) {
                html += '<p class="text-muted">No other rooms are free at this time.</p>';
            } else {
                html += '<div class="d-flex flex-wrap gap-2">';
                freeRoomsResult.forEach(room => {
                    html += `<span class="badge bg-success free-room-badge">${room}</span>`;
                });
                html += '</div>';
            }
            displayDiv.innerHTML = html;
        } catch (error) {
            displayDiv.innerHTML = `<p class="text-center text-danger mt-5">Failed to fetch data: ${error.message}</p>`;
        }
    }

    function createCardHtml(cls) {
        return `
            <div class="schedule-card">
                <p class="card-item mb-1"><strong class="me-2">Time:</strong> ${cls.Time}</p>
                <p class="card-item mb-1"><strong class="me-2">Subject:</strong> ${cls.Subject}</p>
                <p class="card-item mb-0"><strong class="me-2">Room:</strong> ${cls.Room}</p>
            </div>`;
    }

    async function handleSearch(event) {
        event.preventDefault();
        const query = searchInput.value;
        if (!query) return;
        try {
            const response = await fetch(`/search_subject?q=${query}`);
            const results = await response.json();
            if (results.error) throw new Error(results.error);

            let html = `<h3 class="day-header">Search Results for "${query}"</h3>`;
            if (results.length === 0) {
                html += '<p class="text-muted">No matching subjects found.</p>';
            } else {
                 results.forEach(cls => {
                    html += `
                        <div class="search-result-card">
                            <p class="card-item mb-1"><strong class="me-2">Subject:</strong> ${cls.Subject}</p>
                            <p class="card-item mb-1"><strong class="me-2">Program:</strong> ${cls.Program}</p>
                            <p class="card-item mb-1"><strong class="me-2">Section:</strong> ${cls.Section}</p>
                            <p class="card-item mb-1"><strong class="me-2">Day:</strong> ${cls.Day}</p>
                            <p class="card-item mb-0"><strong class="me-2">Room:</strong> ${cls.Room}</p>
                        </div>`;
                });
            }
            displayDiv.innerHTML = html;
        } catch (error) {
            displayDiv.innerHTML = `<p class="text-center text-danger mt-5">Search failed: ${error.message}</p>`;
        }
    }
</script>
</body>
</html>
