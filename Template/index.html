<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>University Timetable Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/ui.css') }}">
    <style>
        body { background-color: #f0f2f5; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .navbar { background-color: #ffffff; border-bottom: 1px solid #dee2e6; }
        .filter-bar { background-color: #ffffff; padding: 1rem; border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-top: 2rem; }
        .day-header { color: #0d6efd; font-weight: 500; margin-top: 2.5rem; margin-bottom: 1rem; }
        .schedule-card, .search-result-card { background-color: #ffffff; border: 1px solid #e9ecef; border-radius: 0.5rem; padding: 1.25rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
        .card-item { font-size: 0.9rem; color: #6c757d; }
        .card-item strong { color: #212529; }
        .card-location { font-size: 0.9rem; color: #495057; }
        .free-room-badge { font-size: 0.95rem; font-weight: 500; padding: 0.5em 0.75em; }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">University Timetable Dashboard</span>
            <a href="/admin" class="btn btn-outline-secondary btn-sm" target="_blank">Admin Panel</a>
        </div>
    </nav>

    <div class="container">
        <div class="filter-bar">
            <div class="row g-2 align-items-center">
                <div class="col-md-3">
                    <select id="program-select" class="form-select" disabled><option>Loading Programs...</option></select>
                </div>
                <div class="col-md-3">
                    <select id="section-select" class="form-select" disabled><option>Select Program First</option></select>
                </div>
                <div class="col-md-3">
                    <select id="day-select" class="form-select" disabled><option>Select Day</option></select>
                </div>
                <div class="col-md-3">
                    <select id="time-select" class="form-select" disabled><option>Select Time</option></select>
                </div>
            </div>
            <div class="row g-2 mt-2 align-items-center">
                <div class="col-md-6">
                     <form id="search-form" class="input-group">
                        <input type="search" id="search-input" class="form-control" placeholder="Search for any subject..." disabled>
                        <button class="btn btn-outline-secondary" type="submit" id="search-button" disabled>Search</button>
                    </form>
                </div>
                <div class="col-md-4">
                    <input class="form-control" list="room-list-options" id="room-input" placeholder="Type or select a room to find..." disabled>
                    <datalist id="room-list-options">
                        </datalist>
                </div>
                <div class="col-md-2">
                    <button id="save-schedule-btn" class="btn btn-success w-100" disabled>Save</button>
                </div>
            </div>
        </div>

        <div id="schedule-display">
            <p id="info-text" class="text-center text-muted mt-5">Please select a program to begin.</p>
        </div>
    </div>

<script>
    // --- DOM Elements ---
    const programSelect = document.getElementById('program-select');
    const sectionSelect = document.getElementById('section-select');
    const daySelect = document.getElementById('day-select');
    const timeSelect = document.getElementById('time-select');
    const searchForm = document.getElementById('search-form');
    const searchInput = document.getElementById('search-input');
    const searchButton = document.getElementById('search-button');
    const roomInput = document.getElementById('room-input');
    const roomDatalist = document.getElementById('room-list-options');
    const saveButton = document.getElementById('save-schedule-btn');
    const displayDiv = document.getElementById('schedule-display');
    const infoText = document.getElementById('info-text');

    // --- Global variable to hold room locations ---
    let roomDirectory = {};

    // --- Event Listeners (FIXED) ---
    document.addEventListener('DOMContentLoaded', loadInitialData);
    programSelect.addEventListener('change', onProgramChange); // <-- UPDATED
    sectionSelect.addEventListener('change', onSectionChange); // <-- UPDATED
    daySelect.addEventListener('change', fetchAndDisplaySchedule); // This was correct
    timeSelect.addEventListener('change', fetchClassAndFreeRooms);
    searchForm.addEventListener('submit', handleSearch);
    roomInput.addEventListener('change', showRoomLocation);
    saveButton.addEventListener('click', saveSchedule);

    // --- Functions ---

    async function loadInitialData() {
        try {
            const [dataResponse, locationResponse] = await Promise.all([
                fetch('/get_initial_data'),
                fetch('/get_all_locations')
            ]);

            if (!dataResponse.ok || !locationResponse.ok) {
                throw new Error('Failed to fetch initial data.');
            }

            const data = await dataResponse.json();
            roomDirectory = await locationResponse.json();

            const roomNames = Object.keys(roomDirectory).sort();
            roomDatalist.innerHTML = '';
            roomNames.forEach(room => {
                const option = document.createElement('option');
                option.value = room;
                roomDatalist.appendChild(option);
            });

            populateDropdown(programSelect, data.programs, 'Select Program');
            populateDropdown(daySelect, data.days, 'Select Day');
            populateDropdown(timeSelect, data.time_slots, 'Select Time');

            searchInput.disabled = false;
            searchButton.disabled = false;
            roomInput.disabled = false;

            await loadSavedSchedule();

        } catch (error) {
            console.error('Error loading initial data:', error);
            infoText.textContent = 'Failed to load initial data. Please reload the page.';
        }
    }

    async function loadSavedSchedule() {
        const savedProgram = localStorage.getItem('myProgram');
        const savedSection = localStorage.getItem('mySection');

        if (savedProgram) {
            programSelect.value = savedProgram;

            // Load sections *before* trying to set the section value
            await loadSections();

            if (savedSection && sectionSelect.querySelector(`option[value="${savedSection}"]`)) {
                sectionSelect.value = savedSection;
                saveButton.textContent = "Saved!";
            }

            const today = new Date().toLocaleString('en-US', { weekday: 'short' });
            if (daySelect.querySelector(`option[value="${today}"]`)) {
                daySelect.value = today;
            }

            await fetchAndDisplaySchedule();

        } else {
            infoText.textContent = 'Please select a program and section to view schedules.';
        }

        saveButton.disabled = false;
    }

    function saveSchedule() {
        const selectedProgram = programSelect.value;
        const selectedSection = sectionSelect.value;

        if (selectedProgram && selectedSection) {
            localStorage.setItem('myProgram', selectedProgram);
            localStorage.setItem('mySection', selectedSection);
            saveButton.textContent = "Saved!";
            saveButton.blur();
        } else {
            alert("Please select both a program and a section before saving.");
        }
    }

    /**
     * NEW: Runs when Program selection changes.
     */
     function onProgramChange() {
        saveButton.textContent = "Save"; // Reset button text
        loadSections(); // Load the sections for the new program
     }

    /**
     * NEW: Runs when Section selection changes.
     */
     function onSectionChange() {
        saveButton.textContent = "Save"; // Reset button text
        fetchAndDisplaySchedule(); // Load the schedule for the new section
     }

    async function loadSections() {
        const selectedProgram = programSelect.value;
        if (!selectedProgram) {
            populateDropdown(sectionSelect, [], 'Select Program First');
            sectionSelect.disabled = true;
            return;
        }
        try {
            const response = await fetch(`/get_sections_for_program?program=${selectedProgram}`);
            const sections = await response.json();
            populateDropdown(sectionSelect, sections, 'Select Section');
            sectionSelect.disabled = false;
        } catch (error) {
            infoText.textContent = 'Failed to load sections for this program.';
        }
    }

    function populateDropdown(selectElement, options, defaultText) {
        selectElement.innerHTML = `<option value="">${defaultText}</option>`;
        options.forEach(option => {
            const opt = document.createElement('option');
            opt.value = option;
            opt.textContent = option;
            selectElement.appendChild(opt);
        });
        selectElement.disabled = false;
    }

    async function fetchAndDisplaySchedule() {
        timeSelect.value = "";
        roomInput.value = "";
        searchInput.value = "";

        const selectedProgram = programSelect.value;
        const selectedSection = sectionSelect.value;
        const selectedDay = daySelect.value;

        if (!selectedProgram || !selectedSection || !selectedDay) {
            displayDiv.innerHTML = `<p class="text-center text-muted mt-5">Please select a program, section, and day.</p>`;
            return;
        }

        try {
            const response = await fetch(`/get_day_schedule?program=${selectedProgram}&section=${selectedSection}&day=${selectedDay}`);
            const schedule = await response.json();
            if (schedule.error) throw new Error(schedule.error);

            let html = `<h3 class="day-header">${selectedDay}'s Schedule (${selectedProgram} - ${selectedSection})</h3>`;
            if (schedule.length === 0) {
                html += '<p class="text-muted">No classes scheduled for this day.</p>';
            } else {
                schedule.forEach(cls => { html += createCardHtml(cls); });
            }
            displayDiv.innerHTML = html;
        } catch (error) {
            displayDiv.innerHTML = `<p class="text-center text-danger mt-5">Failed to fetch schedule: ${error.message}</p>`;
        }
    }

    async function fetchClassAndFreeRooms() {
        roomInput.value = "";
        searchInput.value = "";

        const selectedProgram = programSelect.value;
        const selectedSection = sectionSelect.value;
        const selectedTime = timeSelect.value;

        if (!selectedTime) {
            fetchAndDisplaySchedule();
            return;
        }

        if (!selectedProgram || !selectedSection) {
            infoText.textContent = "Please select a Program and Section first.";
            return;
        }

        const classPromise = fetch(`/get_class_by_time?program=${selectedProgram}&section=${selectedSection}&time=${selectedTime}`);
        const freeRoomsPromise = fetch(`/get_free_rooms?time=${selectedTime}`);

        try {
            const [classResponse, freeRoomsResponse] = await Promise.all([classPromise, freeRoomsPromise]);
            const classResult = await classResponse.json();
            const freeRoomsResult = await freeRoomsResponse.json();

            if (classResult.error) throw new Error(classResult.error);
            if (freeRoomsResult.error) throw new Error(freeRoomsResult.error);

            let html = '';
            html += `<h3 class="day-header">${selectedProgram} / ${selectedSection} at ${selectedTime}</h3>`;
            if (classResult.status === "Free Period") {
                html += '<p class="text-muted">Your section has a free period.</p>';
            } else {
                html += createCardHtml(classResult);
            }

            html += `<h3 class="day-header mt-4">Available Rooms at ${selectedTime}</h3>`;
            if (freeRoomsResult.length === 0) {
                html += '<p class="text-muted">No other rooms are free at this time.</p>';
            } else {
                html += '<div class="d-flex flex-wrap gap-2">';
                freeRoomsResult.forEach(room => {
                    html += `<span class="badge bg-success free-room-badge">${room}</span>`;
                });
                html += '</div>';
            }
            displayDiv.innerHTML = html;
        } catch (error) {
            displayDiv.innerHTML = `<p class="text-center text-danger mt-5">Failed to fetch data: ${error.message}</p>`;
        }
    }

    function createCardHtml(cls) {
        let locationHtml = '';
        if (cls.Room && roomDirectory[cls.Room]) {
            const loc = roomDirectory[cls.Room];
            const building = loc.building || '';
            const floor = loc.floor || '';

            if(building || floor) {
                locationHtml = `
                    <p class="card-item mb-0 card-location"><strong class="me-2">Location:</strong>
                        ${building} ${building && floor ? '-' : ''} ${floor}
                    </p>
                `;
            }
        }

        return `
            <div class="schedule-card">
                <p class="card-item mb-1"><strong class="me-2">Time:</strong> ${cls.Time}</p>
                <p class="card-item mb-1"><strong class="me-2">Subject:</strong> ${cls.Subject}</p>
                <p class="card-item mb-1"><strong class="me-2">Room:</strong> ${cls.Room}</p>
                ${locationHtml}
            </div>`;
    }

    async function handleSearch(event) {
        event.preventDefault();

        daySelect.value = "";
        timeSelect.value = "";
        roomInput.value = "";

        const query = searchInput.value;
        if (!query) return;
        try {
            const response = await fetch(`/search_subject?q=${query}`);
            const results = await response.json();
            if (results.error) throw new Error(results.error);

            let html = `<h3 class="day-header">Search Results for "${query}"</h3>`;
            if (results.length === 0) {
                html += '<p class="text-muted">No matching subjects found.</p>';
            } else {
                 results.forEach(cls => {
                    let locationHtml = '';
                    if (cls.Room && roomDirectory[cls.Room]) {
                        const loc = roomDirectory[cls.Room];
                        const building = loc.building || '';
                        const floor = loc.floor || '';
                        if(building || floor) {
                            locationHtml = `<p class="card-item mb-0 card-location"><strong class="me-2">Location:</strong> ${building} ${building && floor ? '-' : ''} ${floor}</p>`;
                        }
                    }

                    html += `
                        <div class="search-result-card">
                            <p class="card-item mb-1"><strong class="me-2">Subject:</strong> ${cls.Subject}</p>
                            <p class="card-item mb-1"><strong class="me-2">Program:</strong> ${cls.Program}</p>
                            <p class="card-item mb-1"><strong class="me-2">Section:</strong> ${cls.Section}</p>
                            <p class="card-item mb-1"><strong class="me-2">Day:</strong> ${cls.Day}</p>
                            <p class="card-item mb-1"><strong class="me-2">Time:</strong> ${cls.Time}</p>
                            <p class="card-item mb-1"><strong class="me-2">Room:</strong> ${cls.Room}</p>
                            ${locationHtml}
                        </div>`;
                });
            }
            displayDiv.innerHTML = html;
        } catch (error) {
            displayDiv.innerHTML = `<p class="text-center text-danger mt-5">Search failed: ${error.message}</p>`;
        }
    }

    function showRoomLocation() {
        const selectedRoom = roomInput.value;
        if (!selectedRoom) return;

        if (!roomDirectory[selectedRoom]) {
            displayDiv.innerHTML = `<p class="text-center text-muted mt-5">Room "${selectedRoom}" not found in directory.</p>`;
            return;
        }

        daySelect.value = "";
        timeSelect.value = "";
        searchInput.value = "";

        const location = roomDirectory[selectedRoom];

        let html = `<h3 class="day-header">Location for ${selectedRoom}</h3>`;

        if (location && (location.building || location.floor)) {
            html += `
                <div class="schedule-card">
                    <p class="card-item mb-1"><strong class="me-2">Room:</strong> ${selectedRoom}</p>
                    <p class="card-item mb-1"><strong class="me-2">Building:</strong> ${location.building || 'N/A'}</p>
                    <p class="card-item mb-0"><strong class="me-2">Floor:</strong> ${location.floor || 'N/A'}</p>
                </div>
            `;
        } else {
            html += `<p class="text-muted">Location details are not available for this room. Please ask the admin to add it.</p>`;
        }

        displayDiv.innerHTML = html;
    }

</script>
</body>
</html>
